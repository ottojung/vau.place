<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload</title>

  <style>
    /* @import url("https://fonts.googleapis.com/css?family=Raleway:400,700"); */

    *, *:before, *:after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Raleway", sans-serif;
      overflow-x: hidden; /* Prevent horizontal scroll from animations */
    }

    .logincontainter {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh; /* Allow container to grow beyond viewport */
      padding: 20px; /* Equal margins on all sides */
    }

    .logincontainter:hover .top:before, .logincontainter:hover .top:after, .logincontainter:hover .bottom:before, .logincontainter:hover .bottom:after, .logincontainter:active .top:before, .logincontainter:active .top:after, .logincontainter:active .bottom:before, .logincontainter:active .bottom:after {
      margin-left: 200px;
      transform-origin: -200px 50%;
      transition-delay: 0s;
    }

    .logincontainter:hover .center, .logincontainter:active .center {
      opacity: 1;
      transition-delay: 0.2s;
    }

    .logincontainter .top:before, .logincontainter .top:after, .logincontainter .bottom:before, .logincontainter .bottom:after {
      content: "";
      display: block;
      position: absolute;
      width: 200vmax;
      height: 200vmax;
      top: 50%;
      left: 50%;
      margin-top: -100vmax;
      transform-origin: 0 50%;
      transition: all 0.5s cubic-bezier(0.445, 0.05, 0, 1);
      z-index: 10;
      opacity: 0.65;
      transition-delay: 0.2s;
    }

    .logincontainter .top:before {
      transform: rotate(45deg);
      background: #e46569;
    }

    .logincontainter .top:after {
      transform: rotate(135deg);
      background: #ecaf81;
    }

    .logincontainter .bottom:before {
      transform: rotate(-45deg);
      background: #60b8d4;
    }

    .logincontainter .bottom:after {
      transform: rotate(-135deg);
      background: #3745b5;
    }

    #credentialsForm {
      width: min(99%, 400px);
    }

    #fileUploadSection {
      width: min(99%, 500px);
      display: flex;
      flex-direction: column;
    }

    .logincontainter .center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0;
      opacity: 0;
      transition: all 0.5s cubic-bezier(0.445, 0.05, 0, 1);
      transition-delay: 0s;
      color: #333;
      gap: 15px; /* Even spacing between all children */
    }

    .logincontainter .center h2 {
      margin: 0; /* Remove default h2 margins */
    }

    .logincontainter .center input[type="password"] {
      width: 100%;
      padding: 15px;
      margin: 0;
      border-radius: 1px;
      border: 1px solid #ccc;
      font-family: inherit;
    }

    .no-effect .top:before,
    .no-effect .top:after,
    .no-effect .bottom:before,
    .no-effect .bottom:after {
      display: none;
    }

    .no-effect .center {
      opacity: 1 !important; /* Ensure the center content remains visible */
    }

    .filepond--credits {
      display: none;
    }    

    /* Error message styling */
    #errorMessage {
      color: #ff6b6b;
      font-size: 14px;
      font-weight: 500;
      margin: 10px 0 0 0;
      padding: 10px 15px;
      background: rgba(255, 107, 107, 0.1);
      border-left: 3px solid #ff6b6b;
      border-radius: 3px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 100%;
      box-sizing: border-box;
    }

    #errorMessage.show {
      opacity: 1;
      transform: translateY(0);
    }

    .logincontainter .center input[type="password"].error {
      border-color: #ff6b6b;
      animation: shake 0.4s ease-in-out;
    }

    .logincontainter .center input[type="password"]:focus {
      outline: none;
      border-color: #3745b5;
      box-shadow: 0 0 0 2px rgba(55, 69, 181, 0.1);
    }

    .logincontainter .center input[type="password"].error:focus {
      border-color: #ff6b6b;
      box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.1);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Loading state */
    .logincontainter .center input[type="password"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>

  <link href="assets/filepond.min.css" rel="stylesheet">
  <link href="assets/filepond-plugin-image-preview.css" rel="stylesheet" />
  <script src="assets/filepond-plugin-image-preview.js"></script>
  <script src="assets/filepond.js"></script>

  <script>
    window.onload = function () {
      FilePond.registerPlugin();
      try {
        FilePond.registerPlugin(FilePondPluginImagePreview);
      } catch (e) {
        console.warn('Image preview plugin not loaded:', e);
      }

      /**
       * Validates the password against the server using query parameter mode
       * @param {string} password - The password to validate
       * @returns {Promise<boolean>} - True if password is valid, false otherwise
       */
      async function validatePassword(password) {
        try {
          const username = 'admin';
          const authHeader = 'Basic ' + btoa(username + ':' + password);

          if (window.location.protocol === 'file:' || window.location.hostname === 'localhost') {
            // If running locally, assume success for testing purposes. This is safe because the check is only for notifying the user.
            return true;
          }

          const response = await fetch('/up?check', {
            method: 'GET',
            headers: {
              'Authorization': authHeader
            }
          });

          return response.ok && response.status === 200;
        } catch (error) {
          showError('Invalid password. Please try again.');
          return false;
        }
      }

      /**
       * Shows an error message to the user with proper state management
       * @param {string} message - The error message to display
       */
      function showError(message) {
        const inputElement = document.getElementById('inputpassword');
        let errorElement = document.getElementById('errorMessage');

        // Create error element if it doesn't exist
        if (!errorElement) {
          errorElement = document.createElement('div');
          errorElement.id = 'errorMessage';
          inputElement.parentNode.insertBefore(errorElement, inputElement.nextSibling);
        }

        // Update message and show with animation
        errorElement.textContent = message;
        errorElement.classList.add('show');
        inputElement.classList.add('error');
      }

      /**
       * Clears the error message and styling
       */
      function clearError() {
        const inputElement = document.getElementById('inputpassword');
        const errorElement = document.getElementById('errorMessage');

        if (errorElement) {
          errorElement.classList.remove('show');
        }

        inputElement.classList.remove('error');
      }

      /**
       * Transitions to the file upload interface after successful authentication
       * @param {string} password - The validated password
       */
      function transition(password) {
        const username = 'admin';
        const authHeader = 'Basic ' + btoa(username + ':' + password);

        FilePond.create(document.querySelector('.filepond'), {
          allowMultiple: true,
          maxFileSize: '10GB',
          server: {
            url: '/up',
            process: {
              method: 'PUT',
              headers: {
                'Authorization': authHeader
              },
            }
          }
        });

        document.getElementById('fileUploadSection').style.display = 'block';
        document.getElementById('credentialsForm').style.display = 'none';
        document.querySelector('.logincontainter').classList.add('no-effect');
      }

      /**
       * Handles password submission with validation
       * @param {string} password - The password to check and process
       */
      async function handlePasswordSubmit(password) {
        if (!password || password.trim() === '') {
          showError('Please enter a password');
          return;
        }

        const inputElement = document.getElementById('inputpassword');
        clearError(); // Clear any previous errors
        inputElement.disabled = true;

        try {
          const isValid = await validatePassword(password);

          if (isValid) {
            transition(password);
          } else {
            showError('Invalid password. Please try again.');
            inputElement.value = '';
            inputElement.disabled = false;
            inputElement.focus();
          }
        } catch (error) {
          showError('Connection error. Please try again.');
          console.error('Authentication error:', error);
          inputElement.disabled = false;
          inputElement.focus();
        }
      }

      // Initialize event listeners after DOM is ready
      const passwordInput = document.getElementById('inputpassword');

      // Clear error when user starts typing
      passwordInput.addEventListener('input', function() {
        clearError();
      });

      // Handle Enter key press
      passwordInput.addEventListener('keypress', function(event) {
        if (event.key !== 'Enter') {
          return;
        }

        event.preventDefault();
        const password = passwordInput.value;
        handlePasswordSubmit(password);
      });

      // Initialize from URL query parameter if present
      const currentUrl = window.location.href;
      const urlObj = new URL(currentUrl);
      const queryParams = new URLSearchParams(urlObj.search);
      queryParams.forEach((value, key) => {
        if (key === "key") {
           handlePasswordSubmit(value);
        }
      });

    };
  </script>
</head>
<body>
  <div class="logincontainter" onclick="onclick">
    <div class="top"></div>
    <div class="bottom"></div>

    <div class="center" id="credentialsForm">
      <h2>Please Sign In</h2>
      <input type="password" placeholder="password" id="inputpassword"/>
      <h2>&nbsp;</h2>
    </div>

    <div class="center" id="fileUploadSection" style="display:none;">
      <!-- <h2>&nbsp;</h2> -->
      <h2>&nbsp;</h2>
      <input type="file" class="filepond" name="file" multiple>
    </div>
  </div>
</body>
</html>
